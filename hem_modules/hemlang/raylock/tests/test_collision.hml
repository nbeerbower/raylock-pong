// Test suite for collision detection functions
// Run with: hemlock tests/test_collision.hml

let tests_passed = 0;
let tests_failed = 0;

fn assert_true(name: string, condition: i32) {
    if (condition != 0) {
        print("[PASS] " + name);
        tests_passed = tests_passed + 1;
    } else {
        print("[FAIL] " + name + " - expected true");
        tests_failed = tests_failed + 1;
    }
}

fn assert_false(name: string, condition: i32) {
    if (condition == 0) {
        print("[PASS] " + name);
        tests_passed = tests_passed + 1;
    } else {
        print("[FAIL] " + name + " - expected false");
        tests_failed = tests_failed + 1;
    }
}

// ============================================================================
// Collision Detection Functions (same as in raylib.hml)
// ============================================================================

fn CheckCollisionCirclesXY(c1x: f32, c1y: f32, r1: f32, c2x: f32, c2y: f32, r2: f32): i32 {
    let dx = c2x - c1x;
    let dy = c2y - c1y;
    let distSq = dx * dx + dy * dy;
    let radiusSum = r1 + r2;
    if (distSq <= radiusSum * radiusSum) {
        return 1;
    }
    return 0;
}

fn CheckCollisionRectsXY(x1: f32, y1: f32, w1: f32, h1: f32, x2: f32, y2: f32, w2: f32, h2: f32): i32 {
    if (x1 < x2 + w2 && x1 + w1 > x2 && y1 < y2 + h2 && y1 + h1 > y2) {
        return 1;
    }
    return 0;
}

fn CheckCollisionPointRectXY(px: f32, py: f32, rx: f32, ry: f32, rw: f32, rh: f32): i32 {
    if (px >= rx && px <= rx + rw && py >= ry && py <= ry + rh) {
        return 1;
    }
    return 0;
}

fn CheckCollisionPointCircleXY(px: f32, py: f32, cx: f32, cy: f32, r: f32): i32 {
    let dx = px - cx;
    let dy = py - cy;
    let distSq = dx * dx + dy * dy;
    if (distSq <= r * r) {
        return 1;
    }
    return 0;
}

fn CheckCollisionCircleRecXY(cx: f32, cy: f32, r: f32, rx: f32, ry: f32, rw: f32, rh: f32): i32 {
    let closestX = cx;
    let closestY = cy;

    if (cx < rx) { closestX = rx; }
    else if (cx > rx + rw) { closestX = rx + rw; }

    if (cy < ry) { closestY = ry; }
    else if (cy > ry + rh) { closestY = ry + rh; }

    let dx = cx - closestX;
    let dy = cy - closestY;
    let distSq = dx * dx + dy * dy;

    if (distSq <= r * r) {
        return 1;
    }
    return 0;
}

// ============================================================================
// Circle vs Circle Tests
// ============================================================================

print("=== Circle vs Circle Collision Tests ===");

// Overlapping circles
assert_true("Overlapping circles", CheckCollisionCirclesXY(0.0, 0.0, 10.0, 5.0, 0.0, 10.0));

// Touching circles (edge case)
assert_true("Touching circles", CheckCollisionCirclesXY(0.0, 0.0, 10.0, 20.0, 0.0, 10.0));

// Non-overlapping circles
assert_false("Non-overlapping circles", CheckCollisionCirclesXY(0.0, 0.0, 10.0, 25.0, 0.0, 10.0));

// Same position circles
assert_true("Same position circles", CheckCollisionCirclesXY(50.0, 50.0, 20.0, 50.0, 50.0, 15.0));

// Diagonal separation
assert_false("Diagonal far circles", CheckCollisionCirclesXY(0.0, 0.0, 5.0, 100.0, 100.0, 5.0));

// ============================================================================
// Rectangle vs Rectangle Tests
// ============================================================================

print("");
print("=== Rectangle vs Rectangle Collision Tests ===");

// Overlapping rectangles
assert_true("Overlapping rects", CheckCollisionRectsXY(0.0, 0.0, 100.0, 100.0, 50.0, 50.0, 100.0, 100.0));

// Non-overlapping rectangles (horizontal gap)
assert_false("Non-overlapping rects horizontal", CheckCollisionRectsXY(0.0, 0.0, 50.0, 50.0, 100.0, 0.0, 50.0, 50.0));

// Non-overlapping rectangles (vertical gap)
assert_false("Non-overlapping rects vertical", CheckCollisionRectsXY(0.0, 0.0, 50.0, 50.0, 0.0, 100.0, 50.0, 50.0));

// Touching rectangles (edge)
assert_true("Touching rects edge", CheckCollisionRectsXY(0.0, 0.0, 50.0, 50.0, 49.0, 0.0, 50.0, 50.0));

// One rect inside another
assert_true("Rect inside another", CheckCollisionRectsXY(0.0, 0.0, 100.0, 100.0, 25.0, 25.0, 50.0, 50.0));

// ============================================================================
// Point vs Rectangle Tests
// ============================================================================

print("");
print("=== Point vs Rectangle Collision Tests ===");

// Point inside rectangle
assert_true("Point inside rect", CheckCollisionPointRectXY(50.0, 50.0, 0.0, 0.0, 100.0, 100.0));

// Point outside rectangle
assert_false("Point outside rect", CheckCollisionPointRectXY(150.0, 50.0, 0.0, 0.0, 100.0, 100.0));

// Point on edge
assert_true("Point on rect edge", CheckCollisionPointRectXY(0.0, 50.0, 0.0, 0.0, 100.0, 100.0));

// Point at corner
assert_true("Point at rect corner", CheckCollisionPointRectXY(100.0, 100.0, 0.0, 0.0, 100.0, 100.0));

// ============================================================================
// Point vs Circle Tests
// ============================================================================

print("");
print("=== Point vs Circle Collision Tests ===");

// Point inside circle
assert_true("Point inside circle", CheckCollisionPointCircleXY(5.0, 5.0, 0.0, 0.0, 10.0));

// Point outside circle
assert_false("Point outside circle", CheckCollisionPointCircleXY(15.0, 0.0, 0.0, 0.0, 10.0));

// Point on circle edge
assert_true("Point on circle edge", CheckCollisionPointCircleXY(10.0, 0.0, 0.0, 0.0, 10.0));

// Point at circle center
assert_true("Point at circle center", CheckCollisionPointCircleXY(50.0, 50.0, 50.0, 50.0, 25.0));

// ============================================================================
// Circle vs Rectangle Tests
// ============================================================================

print("");
print("=== Circle vs Rectangle Collision Tests ===");

// Circle overlapping rectangle
assert_true("Circle overlapping rect", CheckCollisionCircleRecXY(50.0, 50.0, 30.0, 0.0, 0.0, 100.0, 100.0));

// Circle outside rectangle
assert_false("Circle outside rect", CheckCollisionCircleRecXY(200.0, 200.0, 10.0, 0.0, 0.0, 100.0, 100.0));

// Circle touching rectangle edge
assert_true("Circle touching rect edge", CheckCollisionCircleRecXY(110.0, 50.0, 10.0, 0.0, 0.0, 100.0, 100.0));

// Circle touching rectangle corner
assert_true("Circle touching rect corner", CheckCollisionCircleRecXY(105.0, 105.0, 10.0, 0.0, 0.0, 100.0, 100.0));

// Circle inside rectangle
assert_true("Circle inside rect", CheckCollisionCircleRecXY(50.0, 50.0, 10.0, 0.0, 0.0, 100.0, 100.0));

// ============================================================================
// Summary
// ============================================================================

print("");
print("=== Test Summary ===");
print("Passed: " + tests_passed);
print("Failed: " + tests_failed);

if (tests_failed > 0) {
    exit(1);
}
